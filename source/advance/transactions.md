# Transactions

## Prerequisites

To help you better understand this page, we recommend you first read [Accounts](./accounts.md) and our [introduction to Universal BCOS](../index.md).

## What's a transaction?

A Universal BCOS transaction is initiated by an externally-owned account (EOA), which is managed by a human user rather than a contract, and cryptographically signed instructions by EOA.

Transactions will change the state of the EVM, need to be broadcast to the whole network. Any node can broadcast a request for a transaction to be executed on the EVM; After this happens, a validator will execute the transaction and propagate the resulting state change to the rest of the network.

Note that every transaction is a single atomic operation, so that transactions cannot be interleaved with another.

## Transaction data structure

UBCOS provides multiple transaction types that empower transactions with new capabilities and optimizations for memory footprint and performance: UBCOS transaction and Web3 transaction.

A typical basic transaction has fields as shown below:

| Field     | Description                                                                                                                                                                                                                                                                                                        |
|-----------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| from      | The address of the sender, that have signed this transaction.                                                                                                                                                                                                                                                      |
| to        | The receiving address. (If address stand for an EOA, the transaction will transfer value; for a contract account, the transaction will execute the contract code)                                                                                                                                                  |
| input     | Data attached to the transaction, used for transaction execution, which contains excution arges and [encoded as specified in the ABI specs](https://docs.soliditylang.org/en/latest/abi-spec.html#formal-specification-of-the-encoding). If this transaction is doing a transfer action, this filed will be empty. |
| signature | The cryptographic signature of transaction, what is generated by sender.                                                                                                                                                                                                                                           |
| nonce     | A value used to uniquely identify a senderâ€™s transaction.                                                                                                                                                                                                                                                          |
| value     | The amout of UBCOS utility token to be transferred.                                                                                                                                                                                                                                                                |
| gasLimit  | The maximum amount of transaction fee the transaction is allowed to use. **Note:** gasLimit in UBCOS is controlled in UBCOS system config for now, so this field set manually is not available.                                                                                                                    |
| gasPrice  | A multiplier to get how much the sender will pay in tokens. The amount of tokens the sender will pay is calculated via `gasUsed` * `gasPrice`. **Note:** gasPrice in UBCOS is controlled in UBCOS system config for now, so this field set manually is not available.                                              |

### UBCOS transaction

UBCOS transaction is based on the basic transaction fileds, with additional fields to support UBCOS-specific features. The following fields are supported:

| Field      | Description                                                  |
| ---------- | ------------------------------------------------------------ |
| blockLimit | The maximum block height the transaction is allowed to be included in. |
| extraData  | Additional data attached to the transaction.                 |
| abi        | ABI json string of contract, used in deploy contract.        |
| chainID    | Unlike Web3 chainID, UBCOS chainID is a readable string.     |
| groupID    | Stand for group name.                                        |

### Web3 transaction compatibility

For embracing [Ethereum Json RPC](https://ethereum.org/en/developers/docs/apis/json-rpc/#json-rpc-methods), Universal BCOS also supports the some fields, where in ([EIP-1559](https://eips.ethereum.org/EIPS/eip-1559), [EIP-2930](https://eips.ethereum.org/EIPS/eip-2930), [EIP-4844](https://eips.ethereum.org/EIPS/eip-4844)), to support Ethereum compatibility. Therefore, users can successfully deploy transactions generated by Ethereum development tools on. The following fields are supported:

| Field                | Description                                                  |
| -------------------- | ------------------------------------------------------------ |
| chainId              | The transaction only valid on networks with this `chainID`, which is numeric. |
| accessList           | Specifies a list of addresses and storage keys, gas cost at a discount when transaction access this storage keys. **Note:** every gas cost is quite cheaper then other EVM compatible blockchain in UBCOS, so this field set manually is not available. |
| maxPriorityFeePerGas | The maximum price of the consumed gas to be included as a tip to the validator.  **Note:** gasPrice in UBCOS is controlled in UBCOS system config for now, so this field set manually is not available. |
| maxFeePerGas         | The maximum fee per unit of gas willing to be paid for the transaction.  **Note:** gasPrice in UBCOS is controlled in UBCOS system config for now, so this field set manually is not available. |
| maxFeePerBlobGas     | The maximum fee per unit of gas willing to be paid for the Blob storage.  **Note:** Blob is not available in UBCOS, so this field set manually is not available. |
| blobVersionedHashes  | List of hash outputs from `KZGCommitment.`  **Note:** Blob is not available in UBCOS, so this field set manually is not available. |

## Transaction lifecycle

### Creation

When a user submits a request, the client constructs a transaction, then adds necessary fields like a unique transaction ID and block limit to prevent replay attacks, and sends the transaction via RPC to the node.

### Received in transaction pool

Upon receipt, the node validates the transaction's signature and checks for duplicates. Valid, unique transactions are added to the transaction pool, while others are discarded.

### Transaction broadcasting

Nodes broadcast received transactions to other nodes in the network, using strategies to avoid broadcast storms and ensure wide dissemination.

### Packaging to block

Consensus node is responsible for taking out a certain number of transactions from the transaction pool and form them into blocks for consensus, following a FIFO sequence.

### Transaction execution

After the node receives the block, it calls the block validator to take the transactions out of the block one by one and execute them. Execution results are returned in a receipt.

### Consensus process

Consensus is reached using the PBFT algorithm, where nodes independently execute blocks and exchange results. If over 2/3 agree, the block is confirmed.

### Transaction persistence

After consensus, transactions are written to storage disk, block height and hash mappings are updated, and the transactions are removed from the transaction pool. Users can query transaction data and receipts via transaction hashes.
